From 3fc204d4901a2b55bee8bbf05ada9b0ed0cd1e4d Mon Sep 17 00:00:00 2001
From: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
Date: Thu, 1 Dec 2016 14:24:53 -0800
Subject: [PATCH 2/4] efi: allow efi_mem_desc_lookup find
 EFI_BOOT_SERVICES_CODE regions

CONFIG_EFI_BOOT_SERVICES_WARN detects illegal accesses to EFI_BOOT_-
SERVICES_CODE/DATA memory regions using the offending physical address
of the access. We need the memory descriptor of such region so that
it can be mapped as a fixup to a page fault. These illegal accesses
can occur in both code and data regions. Thus, allow efi_mem_desc_-
lookup to return the descriptor of EFI_BOOT_SERVICES_CODE.

Signed-off-by: Ricardo Neri <ricardo.neri-calderon@linux.intel.com>
---
 drivers/firmware/efi/efi.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/drivers/firmware/efi/efi.c b/drivers/firmware/efi/efi.c
index 501c3f1998e7..5e4cd88edfd7 100644
--- a/drivers/firmware/efi/efi.c
+++ b/drivers/firmware/efi/efi.c
@@ -372,6 +372,9 @@ int efi_mem_desc_lookup(u64 phys_addr, efi_memory_desc_t *out_md)
 
 		if (!(md->attribute & EFI_MEMORY_RUNTIME) &&
 		    md->type != EFI_BOOT_SERVICES_DATA &&
+#if defined(CONFIG_EFI_BOOT_SERVICES_WARN)
+		    md->type != EFI_BOOT_SERVICES_CODE &&
+#endif
 		    md->type != EFI_RUNTIME_SERVICES_DATA) {
 			continue;
 		}
-- 
2.1.4

